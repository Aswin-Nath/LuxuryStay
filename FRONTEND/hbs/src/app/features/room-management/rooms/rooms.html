<app-admin-navbar></app-admin-navbar>

<app-spinner [isLoading]="loading" message="Loading rooms..."></app-spinner>

<div class="bg-gray-50 min-h-screen">
  <div class="flex flex-col lg:flex-row flex-1 w-full mt-16 md:mt-20">
    <!-- Sidebar -->
    <div class="w-full lg:w-64 px-4 md:px-6 lg:px-8 py-6 shrink-0">
      <app-admin-sidebar></app-admin-sidebar>
    </div>

    <!-- Main Content -->
    <main class="flex-1 w-full px-4 md:px-6 lg:px-8 py-6 space-y-6">
      <!-- Loading -->
      <div *ngIf="loading" class="bg-white p-12 text-center rounded-xl shadow">
        <div class="inline-block">
          <div class="animate-spin h-8 w-8 border-4 border-yellow-600 border-t-transparent rounded-full"></div>
        </div>
        <p class="text-gray-600 mt-4">Loading rooms...</p>
      </div>

      <!-- Error -->
      <div *ngIf="error && !loading" class="bg-red-50 border border-red-200 p-4 rounded-xl text-red-700 mb-6">
        {{ error }}
      </div>

      <!-- Header -->
      <div class="relative rounded-2xl p-[3px] bg-linear-to-r from-yellow-600 to-red-700 shadow" *ngIf="!loading">
        <div class="bg-[#fdfaf4] rounded-2xl py-6 md:py-8 px-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="text-2xl md:text-3xl lg:text-4xl text-gray-800 font-bold" style="font-family: 'Pacifico', cursive;">
                Room Management
              </h2>
              <p class="text-gray-600 text-sm md:text-base mt-2">Manage hotel rooms and types</p>
            </div>
            <div class="flex gap-3">
              <button (click)="openBulkUploadModal()" class="flex items-center gap-2 px-4 py-2 bg-yellow-600 text-white rounded-full hover:bg-yellow-700 shadow transition text-sm md:text-base">
                <span class="material-icons text-sm">cloud_upload</span>
                Bulk Add
              </button>
              <button (click)="openAddRoomModal()" class="flex items-center gap-2 px-4 py-2 bg-yellow-600 text-white rounded-full hover:bg-yellow-700 shadow transition text-sm md:text-base">
                <span class="material-icons text-sm">add</span>
                Add Room
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Compact Room Filter -->
      <div class="bg-white shadow-md border border-gray-200 rounded-lg p-3 mb-4" *ngIf="!loading">
        <div class="flex flex-col lg:flex-row flex-wrap items-end gap-3">

          <!-- Room Status - Multi-select Dropdown -->
          <div class="flex flex-col relative dropdown-container">
            <label class="text-xs font-medium text-gray-600 mb-1">Room Status</label>
            <button (click)="openStatusDropdown()" 
              type="button"
              class="p-2 text-sm border border-gray-200 rounded-md focus:ring-1 focus:ring-yellow-500 focus:border-yellow-500 text-left bg-white hover:bg-gray-50 flex justify-between items-center min-w-max">
              <span class="truncate">{{ getSelectedStatusNames() }}</span>
              <span class="material-icons text-sm ml-2">expand_more</span>
            </button>
            
            <!-- Dropdown Menu -->
            <div *ngIf="showStatusDropdown" 
              class="absolute top-full mt-1 left-0 bg-white border border-gray-200 rounded-md shadow-lg z-10 min-w-max">
              <div class="p-2 max-h-48 overflow-y-auto">
                <label class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer">
                  <input type="checkbox" 
                    [checked]="selectedStatuses.length === 0"
                    (change)="selectedStatuses = []; applyFilters()"
                    class="w-4 h-4 accent-yellow-600">
                  <span class="text-sm text-gray-700">All</span>
                </label>
                <hr class="my-2">
                <label *ngFor="let status of statusOptions" 
                  class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer">
                  <input type="checkbox" 
                    [checked]="isStatusSelected(status)"
                    (change)="toggleStatusSelection(status)"
                    class="w-4 h-4 accent-yellow-600">
                  <span class="text-sm text-gray-700">{{ status }}</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Room Type - Multi-select Dropdown -->
          <div class="flex flex-col relative dropdown-container">
            <label class="text-xs font-medium text-gray-600 mb-1">Room Type</label>
            <button (click)="openRoomTypeDropdown()" 
              type="button"
              class="p-2 text-sm border border-gray-200 rounded-md focus:ring-1 focus:ring-yellow-500 focus:border-yellow-500 text-left bg-white hover:bg-gray-50 flex justify-between items-center min-w-max">
              <span class="truncate">{{ getSelectedRoomTypeNames() }}</span>
              <span class="material-icons text-sm ml-2">expand_more</span>
            </button>
            
            <!-- Dropdown Menu -->
            <div *ngIf="showRoomTypeDropdown" 
              class="absolute top-full mt-1 left-0 bg-white border border-gray-200 rounded-md shadow-lg z-10 min-w-max">
              <div class="p-2 max-h-48 overflow-y-auto">
                <label class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer">
                  <input type="checkbox" 
                    [checked]="selectedRoomTypes.length === 0"
                    (change)="selectedRoomTypes = []; applyFilters()"
                    class="w-4 h-4 accent-yellow-600">
                  <span class="text-sm text-gray-700">All</span>
                </label>
                <hr class="my-2">
                <label *ngFor="let roomType of roomTypes" 
                  class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer">
                  <input type="checkbox" 
                    [checked]="isRoomTypeSelected(roomType.room_type_id)"
                    (change)="toggleRoomTypeSelection(roomType.room_type_id)"
                    class="w-4 h-4 accent-yellow-600">
                  <span class="text-sm text-gray-700">{{ roomType.type_name }}</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Price Range -->
          <div class="flex flex-col">
            <label class="text-xs font-medium text-gray-600 mb-1">Price Range (₹)</label>
            <div class="flex items-center gap-2">
              <input type="number" 
                [(ngModel)]="minPrice" 
                (blur)="validateMinPrice()"
                (change)="validatePriceRange()"
                placeholder="Min ₹" 
                min="1"
                class="w-24 p-2 text-sm border border-gray-200 rounded-md focus:ring-1 focus:ring-yellow-500 focus:border-yellow-500">
              <span class="text-gray-400">—</span>
              <input type="number" 
                [(ngModel)]="maxPrice" 
                (blur)="validateMaxPrice()"
                (change)="validatePriceRange()"
                placeholder="Max ₹" 
                min="1"
                class="w-24 p-2 text-sm border border-gray-200 rounded-md focus:ring-1 focus:ring-yellow-500 focus:border-yellow-500">
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="lg:ml-auto flex gap-2">
            <button (click)="resetFilters()" class="px-3 py-2 bg-gray-100 text-gray-700 text-sm rounded-md hover:bg-gray-200 flex items-center gap-1">
              <span class="material-icons text-xs">refresh</span>
              Reset
            </button>
            <button (click)="applyFilters()" class="px-4 py-2 bg-yellow-600 text-white text-sm rounded-md hover:bg-yellow-700 flex items-center gap-1">
              <span class="material-icons text-xs">filter_alt</span>
              Apply
            </button>
          </div>

        </div>
      </div>

      <!-- Table -->
      <div class="bg-white shadow-lg border border-gray-200 rounded-xl overflow-hidden" *ngIf="!loading">
        <table class="w-full text-sm" *ngIf="rooms.length > 0">
          <thead class="bg-yellow-50 border-b border-gray-300">
            <tr>
              <th class="p-3 text-left font-semibold text-gray-700 cursor-pointer hover:bg-yellow-100" (click)="sortBy('room_no')">
                <div class="flex items-center gap-2">
                  <span class="material-icons text-lg text-gray-500">meeting_room</span>
                  <span>Room No</span>
                  <i class="fas ml-1" [ngClass]="getSortIcon('room_no')"></i>
                </div>
              </th>
              <th class="p-3 text-left font-semibold text-gray-700 cursor-pointer hover:bg-yellow-100" (click)="sortBy('room_type_id')">
                <div class="flex items-center gap-2">
                  <span class="material-icons text-lg text-gray-500">king_bed</span>
                  <span>Room Type</span>
                  <i class="fas ml-1" [ngClass]="getSortIcon('room_type_id')"></i>
                </div>
              </th>
              <th class="p-3 text-left font-semibold text-gray-700 cursor-pointer hover:bg-yellow-100" (click)="sortBy('price_per_night')">
                <div class="flex items-center gap-2">
                  <span class="material-icons text-lg text-gray-500">attach_money</span>
                  <span>Price / Night</span>
                  <i class="fas ml-1" [ngClass]="getSortIcon('price_per_night')"></i>
                </div>
              </th>
              <th class="p-3 text-left font-semibold text-gray-700">
                <div class="flex items-center gap-2">
                  <span class="material-icons text-lg text-gray-500">info</span>
                  <span>Status</span>
                </div>
              </th>
              <th class="p-3 text-center font-semibold text-gray-700">
                <div class="flex items-center justify-center gap-2">
                  <span class="material-icons text-lg text-gray-500">settings</span>
                  Action
                </div>
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <tr *ngFor="let room of rooms" class="hover:bg-gray-50">
              <td class="p-3 font-medium text-blue-600">
                <div class="flex items-center gap-2">
                  <span class="material-icons text-gray-600 text-sm">meeting_room</span>
                  {{ room.room_no }}
                </div>
              </td>
              <td class="p-3">
                <div class="flex items-center gap-2">
                  <span class="material-icons text-gray-600 text-sm">king_bed</span>
                  {{ room.room_type.type_name }}
                </div>
              </td>
              <td class="p-3 text-green-600 font-semibold">₹{{ room.room_type.price_per_night }}</td>
              <td class="p-3">
                <span class="px-3 py-1 rounded-full text-xs font-medium inline-flex items-center gap-1" [ngClass]="getStatusColor(room.room_status)">
                  <span class="material-icons text-xs">{{ getStatusIcon(room.room_status) }}</span>
                  {{ room.room_status }}
                </span>
              </td>
              <td class="p-3 text-center">
                <div class="flex items-center justify-center gap-2">
                  <button (click)="viewRoom(room)" class="px-2 py-1 text-yellow-700 hover:bg-yellow-100 rounded transition" title="View">
                    <span class="material-icons text-sm">visibility</span>
                  </button>
                  <button (click)="editRoom(room)" class="px-2 py-1 text-yellow-700 hover:bg-yellow-100 rounded transition" title="Edit">
                    <span class="material-icons text-sm">edit</span>
                  </button>
                  <button (click)="openFreezeModal(room)"
                    [class.text-purple-700]="!isRoomFrozen(room)"
                    [class.text-green-700]="isRoomFrozen(room)"
                    [class.hover:bg-purple-100]="!isRoomFrozen(room)"
                    [class.hover:bg-green-100]="isRoomFrozen(room)"
                    class="px-2 py-1 rounded transition" 
                    [title]="isRoomFrozen(room) ? 'Unfreeze Room' : 'Freeze Room'">
                    <span class="material-icons text-sm">{{ isRoomFrozen(room) ? 'lock_open' : 'lock' }}</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Empty State -->
        <div *ngIf="rooms.length === 0 && !loading && !error" class="p-12 text-center">
          <span class="material-icons text-5xl text-gray-300 mb-4 block">meeting_room</span>
          <p class="text-gray-600 text-lg">No rooms available</p>
        </div>
      </div>

      <!-- Pagination -->
      <div class="bg-white shadow-md border border-gray-200 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-4" *ngIf="!loading && rooms.length > 0">
        <!-- Page Size Selector -->
        <div class="flex items-center gap-3">
          <label class="text-sm font-medium text-gray-700">Rows per page:</label>
          <select [(ngModel)]="pageSize" (change)="changePageSize(pageSize)" class="px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:border-gray-400 focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500">
            <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
          </select>
        </div>

        <!-- Pagination Info -->
        <div class="text-sm text-gray-600">
          Showing <span class="font-semibold">{{ ((currentPage - 1) * pageSize) + 1 }}</span> to 
          <span class="font-semibold">{{ Math.min(currentPage * pageSize, totalRecords) }}</span> of 
          <span class="font-semibold">{{ totalRecords }}</span> rooms
        </div>

        <!-- Page Navigation -->
        <div class="flex items-center gap-2">
          <!-- Previous Button -->
          <button (click)="previousPage()" 
            [disabled]="currentPage === 1"
            class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition">
            <span class="material-icons text-sm">chevron_left</span>
          </button>

          <!-- Page Numbers -->
          <div class="flex items-center gap-1">
            <button *ngFor="let page of getPageNumbers()"
              (click)="goToPage(page)"
              [class.bg-yellow-600]="page === currentPage"
              [class.text-white]="page === currentPage"
              [class.bg-gray-100]="page !== currentPage"
              [class.text-gray-700]="page !== currentPage"
              class="px-3 py-2 rounded-md text-sm font-medium hover:bg-yellow-500 hover:text-white transition">
              {{ page }}
            </button>
          </div>

          <!-- Next Button -->
          <button (click)="nextPage()" 
            [disabled]="currentPage === totalPages"
            class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition">
            <span class="material-icons text-sm">chevron_right</span>
          </button>
        </div>
      </div>

      <!-- Freeze/Unfreeze Modal -->
      <div *ngIf="showFreezeModal && selectedRoomForFreeze" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full">
          <!-- Header with Icon - Color changes based on state -->
          <div class="flex items-center gap-3 mb-4" [ngClass]="{'text-purple-600': !isRoomFrozen(selectedRoomForFreeze), 'text-green-600': isRoomFrozen(selectedRoomForFreeze)}">
            <span class="material-icons text-3xl">{{ isRoomFrozen(selectedRoomForFreeze) ? 'lock_open' : 'lock' }}</span>
            <h3 class="text-xl font-bold text-gray-800">
              {{ isRoomFrozen(selectedRoomForFreeze) ? 'Unfreeze Room' : 'Freeze Room' }}
            </h3>
          </div>

          <!-- Room Info with ID displayed -->
          <p class="text-gray-600 text-sm mb-4 bg-gray-50 p-3 rounded-md">
            <span class="block text-sm">Room #<span class="font-semibold text-gray-900">{{ selectedRoomForFreeze.room_no }}</span></span>
            <span class="block text-xs text-gray-500 mt-1">ID: <span class="font-mono font-semibold text-gray-700">{{ selectedRoomForFreeze.room_id }}</span></span>
          </p>

          <!-- Freeze Reason Dropdown (only show when freezing, not unfreezing) -->
          <div *ngIf="!isRoomFrozen(selectedRoomForFreeze)" class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Freeze Reason <span class="text-gray-400 text-xs">(Optional)</span>
            </label>
            <select [(ngModel)]="freezeReason" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
              <option value="">-- Select Reason --</option>
              <option *ngFor="let option of freezeReasonOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
          </div>

          <!-- Action Buttons - Colors change based on freeze state -->
          <div class="flex gap-3">
            <button (click)="closeFreezeModal()" 
              [disabled]="freezing"
              class="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 font-medium hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition">
              Cancel
            </button>
            <button (click)="submitFreeze()" 
              [disabled]="freezing"
              [ngClass]="{
                'bg-green-600 hover:bg-green-700': isRoomFrozen(selectedRoomForFreeze),
                'bg-purple-600 hover:bg-purple-700': !isRoomFrozen(selectedRoomForFreeze)
              }"
              class="flex-1 px-4 py-2 text-white rounded-md font-medium disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center gap-2">
              <span *ngIf="!freezing" class="material-icons text-sm">{{ isRoomFrozen(selectedRoomForFreeze) ? 'lock_open' : 'lock' }}</span>
              <span *ngIf="freezing" class="inline-block animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
              <span>{{ isRoomFrozen(selectedRoomForFreeze) ? 'Unfreeze' : 'Freeze' }}</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Room Detail Modal -->
      <!-- Removed: Now using separate page route /admin/rooms/:id/view -->

      <!-- Room Edit Modal -->
      <app-edit-room 
        [isOpen]="showEditRoomModal" 
        [roomId]="editingRoomId"
        (close)="closeEditRoomModal()"
        (saved)="onRoomSaved()"
      ></app-edit-room>

      <!-- Add Room Modal -->
      <app-add-room 
        [isOpen]="showAddRoomModal"
        (close)="closeAddRoomModal()"
        (saved)="onAddRoomSaved()"
      ></app-add-room>

      <!-- Bulk Upload Modal -->
      <app-bulk-upload
        [isOpen]="showBulkUploadModal"
        (close)="closeBulkUploadModal()"
        (uploadComplete)="onBulkUploadComplete()"
      ></app-bulk-upload>
    </main>
  </div>
</div>
