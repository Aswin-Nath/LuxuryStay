<app-admin-navbar></app-admin-navbar>

<div class="bg-gray-50 min-h-screen">
  <div class="flex flex-col lg:flex-row flex-1 w-full mt-16 md:mt-20">
    <!-- Sidebar -->
    <div class="w-full lg:w-64 px-4 md:px-6 lg:px-8 py-4 shrink-0">
      <app-admin-sidebar></app-admin-sidebar>
    </div>

    <!-- Main Content -->
    <main class="flex-1 w-full px-4 md:px-6 lg:px-8 py-4 space-y-4">
      <!-- Header -->
      <div class="relative rounded-lg p-[3px] bg-linear-to-r from-yellow-600 to-red-700 shadow">
        <div class="bg-[#fdfaf4] rounded-lg py-4 md:py-6 px-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="text-2xl md:text-3xl text-gray-800 font-bold">Booking Details #{{ bookingId }}</h2>
              <p class="text-gray-600 text-xs md:text-sm mt-1">Complete booking information and history</p>
            </div>
            <div class="flex gap-2">
              <button
                (click)="printBooking()"
                class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition font-medium text-sm"
              >
                <span class="material-icons text-sm">print</span> Print
              </button>
              <button
                (click)="backToList()"
                class="flex items-center gap-2 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition font-medium text-sm"
              >
                <span class="material-icons text-sm">arrow_back</span> Back
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading/Error States -->
      <div *ngIf="loading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-600"></div>
        <p class="text-gray-600 mt-2">Loading booking details...</p>
      </div>

      <div *ngIf="error && !loading" class="alert alert-error bg-red-50 border border-red-200 p-4 rounded-lg text-red-700">
        {{ error }}
      </div>

      <!-- Booking Details -->
      <ng-container *ngIf="booking && !loading">
        <!-- Status and Summary -->
        <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div>
              <label class="text-xs font-semibold text-gray-600">Status</label>
              <div class="mt-1">
                <span [class]="'px-3 py-1 rounded-full text-xs font-semibold ' + getStatusColor(booking.status)">
                  {{ booking.status }}
                </span>
              </div>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-600">Booking Date</label>
              <p class="text-sm text-gray-700 mt-1">{{ formatDateTime(booking.booking_time) }}</p>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-600">Stay Duration</label>
              <p class="text-sm text-gray-700 mt-1">{{ getStayDuration() }} night(s)</p>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-600">Total Rooms</label>
              <p class="text-sm text-gray-700 mt-1">{{ booking.room_count }}</p>
            </div>
          </div>
        </div>

        <!-- Customer Information -->
        <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Customer Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-semibold text-gray-600">Name</label>
              <p class="text-sm text-gray-700 mt-1">{{ booking.primary_customer_name || '-' }}</p>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-600">Phone</label>
              <p class="text-sm text-gray-700 mt-1">{{ booking.primary_customer_phone_number || '-' }}</p>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-600">Date of Birth</label>
              <p class="text-sm text-gray-700 mt-1">{{ formatDate(booking.primary_customer_dob) }}</p>
            </div>
          </div>
        </div>

        <!-- Check-In/Check-Out Information -->
        <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Stay Details</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-semibold text-gray-600">Check-In</label>
              <p class="text-sm text-gray-700 mt-1">
                {{ formatDate(booking.check_in) }} at {{ booking.check_in_time || 'Standard time' }}
              </p>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-600">Check-Out</label>
              <p class="text-sm text-gray-700 mt-1">
                {{ formatDate(booking.check_out) }} at {{ booking.check_out_time || 'Standard time' }}
              </p>
            </div>
          </div>
        </div>

        <!-- Rooms Booked -->
        <div class="bg-white rounded-lg shadow border border-gray-200 p-6" *ngIf="rooms && rooms.length > 0">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Rooms Booked</h3>
          <div class="space-y-3">
            <div *ngFor="let room of rooms" class="flex items-start justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
              <div>
                <p class="font-medium text-gray-800">Room {{ room.room_id }}</p>
                <p class="text-xs text-gray-600">Guest: {{ room.guest_name || 'Not specified' }}</p>
                <p class="text-xs text-gray-600">Adults: {{ room.adults }}, Children: {{ room.children || 0 }}</p>
              </div>
              <div class="text-right">
                <p class="font-semibold text-yellow-600">{{ formatPrice(room.price_per_night || 0) }} /night</p>
                <span
                  class="text-xs px-2 py-1 rounded-full"
                  [class.bg-green-100]="room.is_room_active"
                  [class.text-green-800]="room.is_room_active"
                  [class.bg-gray-100]="!room.is_room_active"
                  [class.text-gray-800]="!room.is_room_active"
                >
                  {{ room.is_room_active ? 'Active' : 'Inactive' }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Information -->
        <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Payment Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs font-semibold text-gray-600">Subtotal</label>
              <p class="text-lg text-gray-700 mt-1 font-semibold">{{ formatPrice(booking.total_price - getTotalTax()) }}</p>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-600">Taxes</label>
              <p class="text-lg text-gray-700 mt-1 font-semibold">{{ formatPrice(getTotalTax()) }}</p>
            </div>
            <div class="col-span-full">
              <label class="text-xs font-semibold text-gray-600">Total Amount</label>
              <p class="text-2xl text-yellow-600 mt-1 font-bold">{{ formatPrice(booking.total_price) }}</p>
            </div>
          </div>

          <!-- Payments List -->
          <div *ngIf="payments && payments.length > 0" class="mt-4 border-t pt-4">
            <h4 class="font-medium text-gray-800 mb-3">Payment Transactions</h4>
            <div class="space-y-2">
              <div *ngFor="let payment of payments" class="flex items-center justify-between p-2 bg-gray-50 rounded">
                <div>
                  <p class="text-sm text-gray-700">{{ payment.payment_method || 'Payment' }}</p>
                  <p class="text-xs text-gray-500">{{ formatDateTime(payment.created_at) }}</p>
                </div>
                <div class="text-right">
                  <p class="font-medium text-gray-800">{{ formatPrice(payment.amount || 0) }}</p>
                  <span class="text-xs px-2 py-0.5 rounded" [class.bg-green-100]="payment.status === 'Completed'" [class.text-green-800]="payment.status === 'Completed'">
                    {{ getPaymentStatus(payment) }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Issues Raised -->
        <div class="bg-white rounded-lg shadow border border-gray-200 p-6" *ngIf="issues && issues.length > 0">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Issues Raised</h3>
          <div class="space-y-3">
            <div *ngFor="let issue of issues" class="p-3 bg-orange-50 border border-orange-200 rounded-lg">
              <p class="font-medium text-gray-800">{{ issue.title }}</p>
              <p class="text-sm text-gray-600 mt-1">{{ issue.description }}</p>
              <p class="text-xs text-gray-500 mt-2">{{ formatDateTime(issue.created_at) }}</p>
            </div>
          </div>
        </div>

        <!-- Empty Issues State -->
        <div class="bg-white rounded-lg shadow border border-gray-200 p-6" *ngIf="(!issues || issues.length === 0)">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Issues Raised</h3>
          <p class="text-sm text-gray-500">No issues reported for this booking.</p>
        </div>


        <!-- Customer Review -->
        <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Customer Review & Response</h3>
          
          <!-- Loading State -->
          <div *ngIf="reviewsLoading" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-600"></div>
            <p class="text-gray-600 mt-2">Loading reviews...</p>
          </div>

          <!-- Review Display (Google-style) -->
          <div *ngIf="!reviewsLoading && bookingReview" class="space-y-4">
            <!-- Customer Review Card -->
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 bg-yellow-400 rounded-full flex items-center justify-center font-bold text-white">
                    {{ (bookingReview.user?.full_name || 'C')[0].toUpperCase() }}
                  </div>
                  <div>
                    <p class="font-semibold text-gray-800">{{ bookingReview.user?.full_name || 'Customer' }}</p>
                    <p class="text-xs text-gray-500">{{ bookingReview.created_at | date: 'short' }}</p>
                  </div>
                </div>
                <div class="flex gap-1">
                  <span *ngFor="let i of [1,2,3,4,5]" class="text-lg" [ngClass]="i <= bookingReview.rating ? 'text-yellow-400' : 'text-gray-300'">â˜…</span>
                </div>
              </div>
              <p class="text-gray-700 mb-3">{{ bookingReview.comment }}</p>

              <!-- Customer Review Images -->
              <div *ngIf="bookingReview.images && bookingReview.images.length > 0" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
                <div *ngFor="let image of bookingReview.images" class="relative group">
                  <img [src]="image.image_url" alt="Review image" class="w-full h-24 object-cover rounded-lg">
                </div>
              </div>
            </div>

            <!-- Admin Response Card (if exists) -->
            <div *ngIf="bookingReview.admin_response" class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
              <div class="flex items-start gap-3 mb-3">
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center font-bold text-white">
                  A
                </div>
                <div>
                  <p class="font-semibold text-blue-800">Admin Response</p>
                  <p class="text-xs text-blue-600">{{ bookingReview.responded_at | date: 'short' }}</p>
                </div>
              </div>
              <p class="text-gray-700 mb-3">{{ bookingReview.admin_response }}</p>

              <!-- Admin Response Images -->
              <div *ngIf="bookingReview.admin_response_images && bookingReview.admin_response_images.length > 0" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div *ngFor="let image of bookingReview.admin_response_images" class="relative group">
                  <img [src]="image.image_url" alt="Admin response image" class="w-full h-24 object-cover rounded-lg">
                </div>
              </div>
            </div>

            <!-- Admin Response Form (only show if not already responded) -->
            <div *ngIf="canAddAdminResponse()" class="bg-blue-50 rounded-lg p-4 border border-blue-300">
              <h4 class="font-semibold text-blue-800 mb-4">Add Your Response</h4>
              <form (ngSubmit)="submitAdminResponse()" #adminResponseForm="ngForm" class="space-y-4">
                <!-- Response Text -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Your Response</label>
                  <textarea
                    [(ngModel)]="adminResponseText"
                    name="adminResponseText"
                    maxlength="500"
                    rows="3"
                    placeholder="Write your response to the customer review (max 500 characters)"
                    class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                  ></textarea>
                  <p class="text-sm text-gray-500 text-right mt-1">
                    {{ (adminResponseText || '').length }}/500
                  </p>
                </div>

                <!-- Image Upload -->
                <div class="space-y-2">
                  <label class="block text-sm font-medium text-gray-700">Upload Images (Optional)</label>
                  <label class="block">
                    <input
                      type="file"
                      multiple
                      accept="image/*"
                      (change)="onAdminImageSelect($event)"
                      class="hidden"
                    />
                    <div class="border-2 border-dashed border-blue-300 rounded-lg p-4 text-center cursor-pointer hover:bg-blue-50 transition">
                      <span class="material-icons text-3xl text-blue-600 block mb-2">image</span>
                      <p class="text-sm font-medium text-gray-700">Click to upload images</p>
                      <p class="text-xs text-gray-500">Max 5 images, 5MB each</p>
                    </div>
                  </label>

                  <!-- Image Previews -->
                  <div *ngIf="adminImagePreviews.length > 0" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    <div *ngFor="let preview of adminImagePreviews; let i = index" class="relative group">
                      <img [src]="preview" alt="Preview" class="w-full h-24 object-cover rounded-lg">
                      <button
                        type="button"
                        (click)="removeAdminImage(i)"
                        class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition"
                      >
                        <span class="material-icons text-sm">close</span>
                      </button>
                    </div>
                  </div>
                </div>

                <div class="flex justify-end gap-3">
                  <button
                    type="button"
                    (click)="resetAdminResponse()"
                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg shadow"
                  >
                    Reset
                  </button>
                  <button
                    type="submit"
                    [disabled]="!adminResponseText || adminResponseText.trim().length === 0 || isSubmittingAdminResponse"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                  >
                    <span *ngIf="!isSubmittingAdminResponse">Submit Response</span>
                    <span *ngIf="isSubmittingAdminResponse" class="flex items-center gap-2">
                      <span class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></span>
                      Submitting...
                    </span>
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- No Reviews State -->
          <div *ngIf="!reviewsLoading && !bookingReview" class="text-center py-8">
            <span class="material-icons text-4xl text-gray-300 mb-2 block">rate_review</span>
            <p class="text-gray-500">No reviews submitted for this booking yet.</p>
          </div>
        </div>
      </ng-container>
    </main>
  </div>
</div>

<!-- Toast Container -->
<div id="adminToast" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>