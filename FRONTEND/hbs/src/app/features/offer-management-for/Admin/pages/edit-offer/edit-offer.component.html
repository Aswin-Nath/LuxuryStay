<app-admin-navbar></app-admin-navbar>

<div class="bg-gray-50 min-h-screen">
  <div class="flex flex-col lg:flex-row flex-1 w-full mt-16 md:mt-20">
    <!-- Sidebar -->
    <div class="w-full lg:w-64 px-4 md:px-6 lg:px-8 py-4 shrink-0">
      <app-admin-sidebar></app-admin-sidebar>
    </div>

    <!-- Main Content -->
    <main class="flex-1 w-full px-4 md:px-6 lg:px-8 py-4 space-y-4">
      <!-- Header -->
      <div class="relative rounded-lg p-[3px] bg-linear-to-r from-yellow-600 to-red-700 shadow">
        <div class="bg-[#fdfaf4] rounded-lg py-4 md:py-6 px-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="text-2xl md:text-3xl text-gray-800 font-bold">Edit Offer #{{ offerId }}</h2>
              <p class="text-gray-600 text-xs md:text-sm mt-1">Update offer information and settings</p>
            </div>
            <button (click)="cancel()" class="flex items-center gap-2 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition font-medium">
              <span class="material-icons">arrow_back</span> Back
            </button>
          </div>
        </div>
      </div>

      <div class="individual-offer-form">
        <!-- Success/Error Messages -->
        <div *ngIf="successMessage" class="alert alert-success">
          {{ successMessage }}
        </div>
        <div *ngIf="error" class="alert alert-error">
          {{ error }}
        </div>

        <!-- Loading State -->
        <div *ngIf="loading" class="loading-state">
          <div class="spinner"></div>
          <p>Processing...</p>
        </div>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" *ngIf="!loading">
      <!-- Basic Information Section -->
      <div class="form-section">
        <h3>Offer Information</h3>

        <div class="form-group">
          <label for="offer_name">Offer Name *</label>
          <input
            id="offer_name"
            type="text"
            formControlName="offer_name"
            placeholder="e.g., Summer Promotion 2024"
            class="form-control"
          />
          <small *ngIf="form.get('offer_name')?.hasError('required')" class="error-text">
            Offer name is required
          </small>
          <small *ngIf="form.get('offer_name')?.hasError('minlength')" class="error-text">
            Offer name must be at least 3 characters
          </small>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea
            id="description"
            formControlName="description"
            placeholder="Describe the offer benefits and details..."
            rows="4"
            class="form-control"
          ></textarea>
          <small *ngIf="form.get('description')?.hasError('minlength')" class="error-text">
            Description must be at least 10 characters
          </small>
        </div>
      </div>

      <!-- Discount Configuration Section -->
      <div class="form-section">
        <h3>Discount Configuration</h3>

        <div class="discount-mode-selector">
          <label class="discount-mode-option">
            <input
              type="radio"
              [(ngModel)]="discountMode"
              value="same"
              (change)="onDiscountModeChange()"
              [ngModelOptions]="{ standalone: true }"
            />
            <span class="radio-label">Same Discount for All Room Types</span>
          </label>

          <label class="discount-mode-option">
            <input
              type="radio"
              [(ngModel)]="discountMode"
              value="per-room"
              (change)="onDiscountModeChange()"
              [ngModelOptions]="{ standalone: true }"
            />
            <span class="radio-label">Different Discount per Room Type</span>
          </label>
        </div>

        <div class="form-group" *ngIf="discountMode === 'same'">
          <label for="discount_percent">Base Discount Percentage (%) *</label>
          <div class="input-with-unit">
            <input
              id="discount_percent"
              type="number"
              formControlName="discount_percent"
              min="0"
              max="100"
              (change)="onBasicDiscountChange()"
              class="form-control"
            />
            <span class="unit">%</span>
          </div>
          <small *ngIf="form.get('discount_percent')?.hasError('required')" class="error-text">
            Discount is required
          </small>
          <small *ngIf="form.get('discount_percent')?.hasError('min')" class="error-text">
            Discount must be at least 0%
          </small>
          <small *ngIf="form.get('discount_percent')?.hasError('max')" class="error-text">
            Discount cannot exceed 100%
          </small>
        </div>
      </div>

      <!-- Room Type Selection Section -->
      <div class="form-section">
        <h3>Room Types & Availability</h3>

        <!-- Total Rooms Counter -->
        <div class="rooms-counter-banner" [class.limit-reached]="!canAddMoreRooms">
          <div class="counter-info">
            <span class="counter-label">Total Rooms Selected:</span>
            <span class="counter-value">{{ totalSelectedRooms }} / {{ 5 }}</span>
          </div>
          <div class="counter-status" [class.warning]="totalSelectedRooms >= 5">
            {{ totalSelectedRooms >= 5 ? '⚠️ Limit Reached' : '✓ Available' }}
          </div>
        </div>

        <div class="form-group">
          <label for="roomTypeSelect">Select Room Type to Add</label>
          <div class="room-type-selector">
            <select
              id="roomTypeSelect"
              #roomTypeSelect
              class="form-control"
            >
              <option value="">-- Choose a room type --</option>
              <option
                *ngFor="let rt of roomTypes"
                [value]="rt.room_type_id"
                [disabled]="isRoomTypeSelected(rt.room_type_id) || !canAddMoreRooms"
              >
                {{ rt.type_name }} ({{ rt.total_count }} available)
              </option>
            </select>
            <button
              type="button"
              class="btn-add"
              (click)="addRoomType(+roomTypeSelect.value)"
              [disabled]="!canAddMoreRooms"
            >
              <span class="material-icons">add</span> Add Room Type
            </button>
          </div>
        </div>

        <!-- Selected Room Types Table -->
        <div *ngIf="selectedRoomTypes.length > 0" class="selected-rooms-table">
          <h4>Selected Room Types</h4>
          <table>
            <thead>
              <tr>
                <th>Room Type</th>
                <th>Total in Hotel</th>
                <th>Selected Count</th>
                <th *ngIf="discountMode === 'per-room'">Discount %</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let rt of selectedRoomTypes">
                <td>{{ rt.type_name }}</td>
                <td class="text-center">{{ rt.total_available }}</td>
                <td class="text-center">
                  <input
                    type="number"
                    [(ngModel)]="rt.selected_count"
                    [ngModelOptions]="{ standalone: true }"
                    min="1"
                    [max]="rt.total_available"
                    class="input-small"
                    (change)="validateRoomCount()"
                  />
                </td>
                <td *ngIf="discountMode === 'per-room'" class="text-center">
                  <div class="input-with-unit">
                    <input
                      type="number"
                      [(ngModel)]="rt.discount_percent"
                      [ngModelOptions]="{ standalone: true }"
                      min="0"
                      max="100"
                      class="input-small"
                    />
                    <span class="unit">%</span>
                  </div>
                </td>
                <td class="text-center">
                  <button
                    type="button"
                    class="btn-remove"
                    (click)="removeRoomType(rt.room_type_id)"
                    title="Remove room type"
                  >
                    <span class="material-icons">delete</span>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <small *ngIf="selectedRoomTypes.length === 0" class="info-text">
          No room types added yet. Select a room type to add (maximum 5 rooms total).
        </small>
        <small *ngIf="selectedRoomTypes.length > 0 && totalSelectedRooms >= 5" class="warning-text">
          ⚠️ You have reached the maximum of 5 rooms. Remove a room type to add another.
        </small>
      </div>

      <!-- Image Upload Section -->
      <div class="form-section">
        <h3>Offer Images</h3>
        
        <!-- Existing Images -->
        <div *ngIf="existingImages && existingImages.length > 0" class="mb-6">
          <p class="text-sm font-medium text-gray-600 mb-3">Existing Images ({{ existingImages.length }})</p>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
            <div *ngFor="let image of existingImages; let i = index" class="relative group">
              <img [src]="image.image_url" alt="Offer image" class="w-full h-24 object-cover rounded-lg" [class.ring-2]="image.is_primary" [class.ring-yellow-500]="image.is_primary">
              <div *ngIf="image.is_primary" class="absolute top-1 left-1 bg-yellow-500 text-white rounded-full p-1">
                <span class="material-icons text-xs">star</span>
              </div>
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 rounded-lg transition flex items-center justify-center gap-1 opacity-0 group-hover:opacity-100">
                <button 
                  (click)="setImageAsPrimary(image.image_id)"
                  [disabled]="image.is_primary"
                  title="Set as primary"
                  class="bg-yellow-600 hover:bg-yellow-700 disabled:opacity-50 text-white rounded-full p-1 transition">
                  <span class="material-icons text-sm">star</span>
                </button>
                <button 
                  (click)="deleteExistingImage(image.image_id, i)"
                  title="Delete image"
                  class="bg-red-600 hover:bg-red-700 text-white rounded-full p-1 transition">
                  <span class="material-icons text-sm">delete</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Upload New Multiple Images -->
        <div class="mt-6 pt-6 border-t border-gray-200">
          <p class="text-sm font-medium text-gray-600 mb-3">Add New Images</p>
          
          <div class="form-group mb-4">
            <label for="multi_image_input">Select Multiple Images</label>
            <input
              id="multi_image_input"
              type="file"
              accept="image/*"
              multiple
              (change)="onMultipleImagesSelected($event)"
              class="form-control"
            />
            <small class="info-text">Supported formats: JPG, PNG, GIF (Max: 5MB each)</small>
          </div>

          <!-- New Image Previews -->
          <div *ngIf="imagePreviews && imagePreviews.length > 0" class="mt-4">
            <p class="text-sm font-medium text-gray-600 mb-3">New Images ({{ imagePreviews.length }})</p>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
              <div *ngFor="let preview of imagePreviews; let i = index" class="relative group">
                <img [src]="preview" alt="New offer image" class="w-full h-24 object-cover rounded-lg" [class.ring-2]="i === primaryImageIndex" [class.ring-yellow-500]="i === primaryImageIndex">
                <div *ngIf="i === primaryImageIndex" class="absolute top-1 left-1 bg-yellow-500 text-white rounded-full p-1">
                  <span class="material-icons text-xs">star</span>
                </div>
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 rounded-lg transition flex items-center justify-center gap-1 opacity-0 group-hover:opacity-100">
                  <button 
                    type="button"
                    (click)="setImageAsPrimaryNew(i)"
                    [disabled]="i === primaryImageIndex"
                    title="Set as primary"
                    class="bg-yellow-600 hover:bg-yellow-700 disabled:opacity-50 text-white rounded-full p-1 transition">
                    <span class="material-icons text-sm">star</span>
                  </button>
                  <button 
                    type="button"
                    (click)="removeImagePreview(i)"
                    title="Remove image"
                    class="bg-red-600 hover:bg-red-700 text-white rounded-full p-1 transition">
                    <span class="material-icons text-sm">delete</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Validity Period Section -->
      <div class="form-section">
        <h3>Offer Validity</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="valid_from">Valid From *</label>
            <input
              id="valid_from"
              type="date"
              formControlName="valid_from"
              class="form-control"
            />
            <small *ngIf="form.get('valid_from')?.hasError('required')" class="error-text">
              Start date is required
            </small>
          </div>

          <div class="form-group">
            <label for="valid_to">Valid To *</label>
            <input
              id="valid_to"
              type="date"
              formControlName="valid_to"
              class="form-control"
            />
            <small *ngIf="form.get('valid_to')?.hasError('required')" class="error-text">
              End date is required
            </small>
          </div>
        </div>

        <div class="form-group">
          <label for="max_uses">Maximum Uses (Leave empty for unlimited)</label>
          <input
            id="max_uses"
            type="number"
            formControlName="max_uses"
            min="1"
            placeholder="e.g., 100"
            class="form-control"
          />
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button
          type="submit"
          class="btn-primary"
          [disabled]="loading || !form.valid"
        >
          <span class="material-icons">save</span> Update Offer
        </button>
        <button
          type="button"
          class="btn-secondary"
          (click)="cancel()"
          [disabled]="loading"
        >
          <span class="material-icons">cancel</span> Cancel
        </button>
      </div>
    </form>
    </div>
    </main>
  </div>
</div>
