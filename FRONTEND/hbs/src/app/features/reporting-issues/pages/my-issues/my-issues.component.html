<app-customer-navbar></app-customer-navbar>

<div class="bg-gray-50 flex flex-col min-h-screen">
  <div *ngIf="isLoading" class="flex items-center justify-center min-h-screen">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
      <p class="text-gray-600">Loading issues...</p>
    </div>
  </div>

  <div *ngIf="!isLoading" class="flex flex-col lg:flex-row flex-1 w-full mt-16 md:mt-20">

    <div class="w-full lg:w-64 px-4 md:px-6 lg:px-8 py-6">
      <app-customer-sidebar [currentPage]="'issues'"></app-customer-sidebar>
    </div>

    <main class="flex-1 w-full mx-auto px-4 md:px-6 lg:px-8 py-6 space-y-8 max-w-6xl">

      <div class="relative rounded-2xl p-[3px] bg-linear-to-r from-yellow-600 to-red-700 shadow">
        <div class="bg-[#fdfaf4] rounded-2xl py-6 md:py-8 text-center">
          <h2 class="text-2xl md:text-4xl text-gray-800 font-bold" style="font-family: 'Pacifico', cursive;">
            My Issues
          </h2>
          <p class="mt-2 text-gray-600 text-sm md:text-base">Track your reported issues, monitor status.</p>
        </div>
      </div>

      <div class="bg-white shadow-xl border border-gray-100 rounded-xl p-4 md:p-6">
        <div class="flex flex-wrap items-end gap-4 md:gap-6">
          <div class="flex flex-col">
            <label class="text-xs font-semibold text-gray-700 mb-1">Status</label>
            <select [(ngModel)]="filterStatus" (change)="applyFilters()" class="p-2.5 text-sm border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
              <option value="all">All</option>
              <option value="OPEN">Open</option>
              <option value="IN_PROGRESS">In Progress</option>
              <option value="RESOLVED">Resolved</option>
              <option value="CLOSED">Closed</option>
            </select>
          </div>

          <div class="flex flex-col flex-1 min-w-[200px]">
            <label class="text-xs font-semibold text-gray-700 mb-1">Search</label>
            <input type="text" [(ngModel)]="searchText" placeholder="Search title or description..." 
                   class="p-2.5 text-sm border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
          </div>

          <div class="flex flex-col w-20">
            <label class="text-xs font-semibold text-gray-700 mb-1">Room No</label>
            <input type="number" [(ngModel)]="roomNo" placeholder="#" 
                   class="p-2.5 text-sm border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
          </div>

          <div class="flex flex-col">
            <label class="text-xs font-semibold text-gray-700 mb-1">From Date</label>
            <input type="date" [(ngModel)]="dateRangeStart" (change)="applyFilters()" 
                   class="p-2.5 text-sm border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
          </div>

          <div class="flex flex-col">
            <label class="text-xs font-semibold text-gray-700 mb-1">To Date</label>
            <input type="date" [(ngModel)]="dateRangeEnd" (change)="applyFilters()" 
                   class="p-2.5 text-sm border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
          </div>

          <div class="flex flex-col">
            <label class="text-xs font-semibold text-gray-700 mb-1">Sort By</label>
            <select [(ngModel)]="sortBy" (change)="applyFilters()" class="p-2.5 text-sm border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
              <option value="recent">Most Recent</option>
              <option value="oldest">Oldest</option>
              <option value="title">Title</option>
            </select>
          </div>

          <div class="ml-auto flex gap-3">
            <button (click)="resetFilters()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition">
              <span class="material-icons text-lg align-middle mr-1">refresh</span> Reset
            </button>
            <button (click)="applyFilters()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium shadow-md transition">
              <span class="material-icons text-lg align-middle mr-1">search</span> Search
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="errorMessage" class="bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg">
        <p class="font-semibold">{{ errorMessage }}</p>
      </div>

      <div *ngIf="!isLoading && filteredIssues.length === 0" class="bg-white border border-gray-200 px-4 py-10 rounded-xl text-center text-gray-500 shadow-sm">
        <span class="material-icons text-4xl mb-3 text-gray-400">info_outline</span>
        <p class="font-medium text-lg">No issues found matching your criteria.</p>
        <p class="text-sm mt-1">Try adjusting your filters or create a new issue.</p>
      </div>

      <div *ngIf="!isLoading && filteredIssues.length > 0" class="overflow-x-auto bg-white shadow-xl border border-gray-100 rounded-xl">
        <table class="w-full text-sm">
          <thead class="bg-blue-50 border-b border-blue-200">
            <tr>
              <th class="px-4 py-4 text-left font-bold text-blue-800">Issue ID</th>
              <th class="px-4 py-4 text-left font-bold text-blue-800">Title</th>
              <th class="px-4 py-4 text-left font-bold text-blue-800">Status</th>
              <th class="px-4 py-4 text-left font-bold text-blue-800 hidden md:table-cell">Reported</th>
              <th class="px-4 py-4 text-left font-bold text-blue-800">Actions</th>
            </tr>
          </thead>

          <tbody class="divide-y divide-gray-100">
            <tr *ngFor="let issue of getCurrentPageIssues()" class="hover:bg-blue-50 transition duration-150">
              <td class="px-4 py-4 font-bold text-blue-600">#{{ issue.issue_id }}</td>
              <td class="px-4 py-4 text-gray-800 max-w-xs truncate font-medium">{{ issue.title }}</td>
              <td class="px-4 py-4">
                <span [ngClass]="getStatusColor(issue.status)" class="px-3 py-1 rounded-full text-xs font-bold shadow-sm">
                  {{ issue.status }}
                </span>
              </td>
              <td class="px-4 py-4 text-gray-500 text-xs hidden md:table-cell">{{ formatDate(issue.reported_at) }}</td>
              <td class="px-4 py-4 flex gap-2">
                <button (click)="viewIssueDetails(issue.issue_id)" class="px-3 py-1 border border-blue-500 text-blue-500 hover:bg-blue-50 text-xs rounded-lg transition font-medium">
                  View
                </button>
                <button 
                  [disabled]="issue.status.toLocaleUpperCase() === 'RESOLVED'"
                  (click)="editIssue(issue.issue_id)"
                  class="px-3 py-1 
                        bg-green-500 
                        hover:bg-green-600 
                        text-white text-xs rounded-lg transition font-medium
                        disabled:bg-gray-400 
                        disabled:cursor-not-allowed 
                        disabled:hover:bg-gray-400"
                >
                  Edit
                </button>

              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="bg-white shadow-md border border-gray-200 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-4" *ngIf="!isLoading && filteredIssues.length > 0">
        <!-- Page Size Selector -->
        <div class="flex items-center gap-3">
          <label class="text-sm font-medium text-gray-700">Rows per page:</label>
          <select [(ngModel)]="pageSize" (change)="changePageSize(pageSize)" class="px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:border-gray-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
            <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
          </select>
        </div>

        <!-- Pagination Info -->
        <div class="text-sm text-gray-600">
          Showing <span class="font-semibold">{{ ((currentPage - 1) * pageSize) + 1 }}</span> to 
          <span class="font-semibold">{{ Math.min(currentPage * pageSize, totalRecords) }}</span> of 
          <span class="font-semibold">{{ totalRecords }}</span> issues
        </div>

        <!-- Page Navigation -->
        <div class="flex items-center gap-2">
          <!-- Previous Button -->
          <button (click)="previousPage()" 
            [disabled]="currentPage === 1"
            class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition">
            <span class="material-icons text-sm">chevron_left</span>
          </button>

          <!-- Page Numbers -->
          <div class="flex items-center gap-1">
            <button *ngFor="let page of getPageNumbers()"
              (click)="goToPage(page)"
              [class.bg-blue-600]="page === currentPage"
              [class.text-white]="page === currentPage"
              [class.bg-gray-100]="page !== currentPage && page !== -1"
              [class.text-gray-700]="page !== currentPage && page !== -1"
              [disabled]="page === -1"
              class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-500 hover:text-white transition disabled:bg-transparent disabled:text-gray-400 disabled:cursor-default disabled:hover:bg-transparent disabled:hover:text-gray-400">
              {{ page === -1 ? '...' : page }}
            </button>
          </div>

          <!-- Next Button -->
          <button (click)="nextPage()" 
            [disabled]="currentPage === totalPages"
            class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition">
            <span class="material-icons text-sm">chevron_right</span>
          </button>
        </div>
      </div>
    </main>
  </div>
</div>