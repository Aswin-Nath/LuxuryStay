<div *ngIf="loading" class="flex justify-center items-center p-8">
  <div class="text-center">
    <div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-4 text-gray-600">Loading refunds...</p>
  </div>
</div>

<div *ngIf="!loading && error" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
  <p class="text-red-700 font-semibold">{{ error }}</p>
  <button
    (click)="loadRefunds()"
    class="mt-2 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
  >
    Try Again
  </button>
</div>

<div *ngIf="!loading && !error">
  <!-- ✅ Welcome Header -->
  <div class="relative rounded-2xl p-[3px] bg-linear-to-r from-yellow-600 to-red-700 shadow mb-8">
    <div class="bg-white rounded-2xl p-6 md:p-8">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-800">My Refunds</h1>
      <p class="text-gray-600 mt-2">View and track your refund requests</p>
    </div>
  </div>

  <!-- ✅ Search and Filters -->
  <div class="bg-white shadow-md border border-gray-200 rounded-lg p-4 mb-6">
    <!-- Search Bar -->
    <div class="mb-4">
      <div class="relative">
        <input
          type="text"
          placeholder="Search booking ID..."
          [(ngModel)]="filters.booking_id"
          class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"
        />
        <i class="material-icons absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</i>
      </div>
    </div>

    <div class="flex flex-wrap items-end gap-3">
      <!-- Refund Status -->
      <div class="flex flex-col">
        <label class="text-xs font-medium text-gray-600 mb-1">Refund Status</label>
        <select
          [(ngModel)]="filters.status"
          class="p-2 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-yellow-500"
        >
          <option *ngFor="let opt of statusOptions" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>
      </div>

      <!-- Refund Type -->
      <div class="flex flex-col">
        <label class="text-xs font-medium text-gray-600 mb-1">Refund Type</label>
        <select
          [(ngModel)]="filters.type"
          class="p-2 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-yellow-500"
        >
          <option *ngFor="let opt of typeOptions" [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>
      </div>

      <!-- Date Range -->
      <div class="flex flex-col">
        <label class="text-xs font-medium text-gray-600 mb-1">From Date</label>
        <input
          type="date"
          [(ngModel)]="filters.from_date"
          class="p-2 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-yellow-500"
        />
      </div>

      <div class="flex flex-col">
        <label class="text-xs font-medium text-gray-600 mb-1">To Date</label>
        <input
          type="date"
          [(ngModel)]="filters.to_date"
          class="p-2 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-yellow-500"
        />
      </div>

      <!-- Action Buttons -->
      <div class="ml-auto flex gap-2">
        <button
          (click)="clearFilters()"
          class="px-3 py-2 bg-gray-100 text-gray-700 text-sm rounded-md hover:bg-gray-200 flex items-center gap-1"
        >
          <span class="material-icons text-sm">clear</span>
          Clear
        </button>
        <button
          (click)="applyFilters()"
          class="px-4 py-2 bg-yellow-600 text-white text-sm rounded-md hover:bg-yellow-700 flex items-center gap-1"
        >
          <span class="material-icons text-sm">search</span>
          Apply
        </button>
      </div>
    </div>
  </div>

  <!-- ✅ Refunds Table -->
  <div class="overflow-x-auto bg-white shadow-lg border border-gray-200 rounded-xl">
    <table class="w-full text-sm" *ngIf="refunds.length > 0; else noRefunds">
      <thead class="bg-yellow-50 border-b border-gray-300">
        <tr>
          <th class="px-6 py-3 text-left font-semibold text-gray-700">Refund ID</th>
          <th class="px-6 py-3 text-left font-semibold text-gray-700">Booking ID</th>
          <th class="px-6 py-3 text-left font-semibold text-gray-700">Type</th>
          <th class="px-6 py-3 text-left font-semibold text-gray-700">Amount</th>
          <th class="px-6 py-3 text-left font-semibold text-gray-700">Status</th>
          <th class="px-6 py-3 text-left font-semibold text-gray-700">Initiated</th>
          <th class="px-6 py-3 text-center font-semibold text-gray-700">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        <tr *ngFor="let refund of refunds" class="hover:bg-gray-50">
          <td class="px-6 py-4 font-medium text-gray-900">RF-{{ refund.refund_id }}</td>
          <td class="px-6 py-4 text-gray-600">BK-{{ refund.booking_id }}</td>
          <td class="px-6 py-4">
            <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
              {{ getTypeLabel(refund.type) }}
            </span>
          </td>
          <td class="px-6 py-4 font-semibold text-green-600">
            {{ formatCurrency(refund.refund_amount) }}
          </td>
          <td class="px-6 py-4">
            <span [ngClass]="getStatusColor(refund.status)" class="px-3 py-1 rounded-full text-xs font-semibold flex items-center gap-1 w-fit">
              <span class="material-icons text-sm">{{ getStatusIcon(refund.status) }}</span>
              {{ refund.status }}
            </span>
          </td>
          <td class="px-6 py-4 text-gray-500 text-xs">{{ formatDate(refund.initiated_at) }}</td>
          <td class="px-6 py-4 text-center">
            <button
              (click)="viewRefund(refund.refund_id)"
              class="px-3 py-1 bg-yellow-500 text-white text-xs rounded-md hover:bg-yellow-600 flex items-center gap-1 justify-center"
            >
              <span class="material-icons text-sm">visibility</span>
              View
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <ng-template #noRefunds>
      <div class="p-8 text-center">
        <span class="material-icons text-5xl text-gray-300 block mb-4">folder_open</span>
        <p class="text-gray-600 font-medium">No refunds found</p>
        <p class="text-gray-500 text-sm mt-1">Try adjusting your filters</p>
      </div>
    </ng-template>
  </div>

  <!-- ✅ Pagination -->
  <div *ngIf="totalPages > 1" class="pagination-container">
    <div class="pagination-info">
      Showing {{ (currentPage - 1) * pageSize + 1 }}-{{ Math.min(currentPage * pageSize, totalRefunds) }} of {{ totalRefunds }} refunds
    </div>

    <div class="pagination-controls">
      <button
        (click)="previousPage()"
        [disabled]="currentPage === 1"
        class="pagination-button"
      >
        <span class="material-icons text-sm">chevron_left</span>
        Previous
      </button>

      <div class="page-numbers">
        <button
          *ngFor="let pageNum of getPaginationArray()"
          (click)="goToPage(pageNum)"
          [class.active]="pageNum === currentPage"
          class="page-number"
        >
          {{ pageNum }}
        </button>
      </div>

      <button
        (click)="nextPage()"
        [disabled]="currentPage >= totalPages"
        class="pagination-button"
      >
        Next
        <span class="material-icons text-sm">chevron_right</span>
      </button>

      <div class="jump-to-page">
        <input
          type="number"
          min="1"
          [(ngModel)]="jumpPageInput"
          class="jump-input"
          placeholder="Page"
        />
        <button
          (click)="jumpToPage(jumpPageInput)"
          class="btn-jump"
        >
          Go
        </button>
      </div>
    </div>
  </div>
</div>
